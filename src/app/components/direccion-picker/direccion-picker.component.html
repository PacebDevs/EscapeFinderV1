<div class="direccion-picker">
  <ion-item button lines="none" class="trigger" (click)="togglePanel()">
    <ion-label class="ubicacion-label">
      <div class="linea-ubicacion">
        <span class="ciudad" [class.seleccionada]="ciudadActual">{{ ciudadActual ? ciudadActual : 'Dirección' }}</span>
  <ng-container *ngIf="ciudadActual && !calleNumero">
          <span class="centro">(centro)</span>
        </ng-container>
        <ng-container *ngIf="calleNumero">
          <span class="sep">·</span>
          <span #direccionEl class="direccion" [class.compacta]="direccionCompacta">{{ calleNumero }}</span>
        </ng-container>
      </div>
    </ion-label>
    <ion-icon name="chevron-down-outline" slot="end"></ion-icon>
  </ion-item>

  <!-- Modal tipo hoja al 50% -->
  <ion-modal
    [isOpen]="abierto"
    [initialBreakpoint]="initialBreakpoint"
    [breakpoints]="breakpoints"
    (didDismiss)="onModalDismiss()">
    <ng-template>
      <ion-header class="modal-header">
        <div class="header-content">
          <h2>Seleccionar dirección</h2>
          <ion-icon name="close-outline" class="close-icon" (click)="togglePanel()"></ion-icon>
        </div>
      </ion-header>

      <ion-content class="modal-content">
        <div class="top-actions">
          <ion-button size="small" fill="solid" color="success" class="action-btn locate-btn" (click)="usarMiUbicacion()">
            <ion-icon name="locate" slot="start"></ion-icon>
            Usar mi ubicación
          </ion-button>
          <ion-button size="small" fill="outline" color="medium" class="action-btn clear-btn" (click)="borrar()">
            <ion-icon name="trash-outline" slot="start"></ion-icon>
            Borrar dirección
          </ion-button>
        </div>

        <ion-searchbar
          class="searchbar-custom"
          animated="true"
          showClearButton="focus"
          searchIcon="search-outline"
          enterkeyhint="search"
          inputmode="search"
          [(ngModel)]="query"
          (ionInput)="buscar()"
          showCancelButton="never"
          placeholder="Buscar ciudad o dirección">
        </ion-searchbar>

        <!-- Dirección completa seleccionada, centrada; se muestra solo cuando no hay autocompletados -->
        <div class="direccion-completa-wrapper" *ngIf="direccionActual && predicciones.length === 0">
          <div class="direccion-completa" role="note" aria-label="Ubicación actual seleccionada">
            <ion-badge color="success" class="badge-actual">
              <ion-icon name="checkmark-circle-outline"></ion-icon>
              <span>Ubicación actual</span>
            </ion-badge>
            <div class="direccion-completa-line">
              <ion-icon name="location-outline" class="direccion-completa-icon" aria-hidden="true"></ion-icon>
              <span class="direccion-completa-text">{{ direccionActual }}</span>
            </div>
          </div>
        </div>

        <div class="predicciones-panel">
          <ion-list *ngIf="predicciones.length > 0" class="predictions-list">
            <ion-item button lines="none" class="prediction-item" *ngFor="let p of predicciones" (click)="seleccionar(p)">
              <ion-icon name="location-outline" slot="start" class="prediction-icon"></ion-icon>
              <ion-label [innerHTML]="highlight(p)"></ion-label>
              <ion-icon name="chevron-forward-outline" slot="end" class="prediction-chevron"></ion-icon>
            </ion-item>
          </ion-list>
          <ion-item *ngIf="mostrarNoResultados && query.length > 0" lines="none">
            <ion-label color="medium">No se encontraron resultados</ion-label>
          </ion-item>
        </div>
      </ion-content>
    </ng-template>
  </ion-modal>
</div>
